<script>
  let sites = [];
  let audio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
  let intervaloID = null;
  let logs = [];

  function carregarSites(callback) {
    fetch("sites.txt")
      .then(response => response.text())
      .then(text => {
        sites = text
          .split('\n')
          .map(url => url.trim())
          .filter(url => url.length > 0);
        if (callback) callback();
      })
      .catch(err => {
        alert("Erro ao carregar a lista de sites.");
        console.error(err);
      });
  }

  function atualizarStatus() {
    const tabela = document.getElementById("tabela-sites");
    tabela.innerHTML = "";
    let algumForaDoAr = false;
    const hora = new Date().toLocaleTimeString();

    sites.forEach(site => {
      const linha = document.createElement("tr");
      const cellSite = document.createElement("td");
      const cellStatus = document.createElement("td");
      const cellHora = document.createElement("td");

      cellSite.textContent = site;
      cellHora.textContent = hora;

      fetch(site, { method: "HEAD", mode: "no-cors" })
        .then(() => {
          cellStatus.textContent = "✅ Online";
          cellStatus.className = "up";
          adicionarLog(site, "Online", hora);
          linha.append(cellSite, cellStatus, cellHora);
          tabela.appendChild(linha);
        })
        .catch(() => {
          cellStatus.textContent = "❌ Offline";
          cellStatus.className = "down";
          adicionarLog(site, "Offline", hora);
          linha.append(cellSite, cellStatus, cellHora);
          tabela.appendChild(linha);
          algumForaDoAr = true;
          mostrarAlerta();
        });
    });

    if (!algumForaDoAr) ocultarAlerta();
  }

  function adicionarLog(site, status, hora) {
    logs.push({ site, status, hora });
  }

  function downloadCSV() {
    const csvContent = "data:text/csv;charset=utf-8,Site,Status,Hora\n" +
      logs.map(l => `${l.site},${l.status},${l.hora}`).join("\n");

    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `logs_monitoramento_${Date.now()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function mostrarAlerta() {
    document.getElementById("alerta").style.display = "block";
    audio.play();
  }

  function ocultarAlerta() {
    document.getElementById("alerta").style.display = "none";
  }

  function startMonitoring() {
    if (intervaloID) clearInterval(intervaloID);
    carregarSites(() => {
      atualizarStatus();
      const intervalo = parseInt(document.getElementById("intervalo").value) || 5;
      intervaloID = setInterval(atualizarStatus, intervalo * 60 * 1000);
    });
  }

  function stopMonitoring() {
    if (intervaloID) {
      clearInterval(intervaloID);
      intervaloID = null;
      alert("Monitoramento parado.");
    }
  }
</script>
